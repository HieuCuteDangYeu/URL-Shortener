syntax = "proto3";

import "google/api/annotations.proto";
import "google/protobuf/empty.proto";

option csharp_namespace = "UrlShortener.Shared.Protos";

package urlshortener;

service AnalyticsGrpc {
  rpc IngestClick (ClickEvent) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      post: "/v1/ingest/click"
      body: "*"
    };
  }

  rpc IngestLinkCreated (LinkCreatedEvent) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      post: "/v1/ingest/link"
      body: "*"
    };
  }

  rpc GetPerformance (AnalyticsRequest) returns (PerformanceMetric) {
    option (google.api.http) = {
      get: "/v1/performance"
    };
  }

  rpc GetBrowserDistribution (AnalyticsRequest) returns (BrowserDistribution) {
    option (google.api.http) = {
      get: "/v1/browser-distribution"
    };
  }

  rpc GetDeviceDistribution (AnalyticsRequest) returns (DeviceDistribution) {
    option (google.api.http) = {
      get: "/v1/device-distribution"
    };
  }

  rpc GetTopLinks (AnalyticsRequest) returns (TopLinksResponse) {
    option (google.api.http) = {
      get: "/v1/top-links"
    };
  }

  rpc GetUsers (AnalyticsRequest) returns (UsersResponse) {
    option (google.api.http) = {
      get: "/v1/users"
    };
  }
}

message ClickEvent {
  string shortUrlId = 1;
  string browser = 2;
  string device = 3;
  string ip = 4;
  string referrer = 5;
  string userId = 6;
  int64 timestamp = 7; // unix seconds
}

message LinkCreatedEvent {
  string shortUrlId = 1;
  string originalUrl = 2;
  string userId = 3;
  int64 timestamp = 4;
}

message AnalyticsRequest {
  string period = 1; // e.g. "7d"
  int32 limit = 2;
}

message PerformanceMetric {
  int64 totalClicks = 1;
  int32 activeUsers = 2;
}

message BrowserDistribution {
  repeated string browserNames = 1;
  repeated int32 counts = 2;
}

message DeviceDistribution {
  repeated string deviceTypes = 1;
  repeated int32 counts = 2;
}

message TopLink {
  string shortUrlId = 1;
  int32 clicks = 2;
}

message TopLinksResponse {
  repeated TopLink links = 1;
}

message UsersResponse {
  repeated string userIds = 1;
}